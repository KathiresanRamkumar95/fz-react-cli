<html>
    <head>
        <link rel='stylesheet' type="text/css" href="./css/report.css"/>
    </head>
    <body>
        <div id='output' class='parent'></div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react.js"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.2.0/react-dom.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.5.2/redux.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/react-redux/4.4.5/react-redux.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
        <script src="./js/reports.js"></script>
        <script src="./js/master.js"></script>
        <script type="text/babel">
            let higherOrderReducer = (defaultValue, checkingQuery, logic)=>{
                return (state=defaultValue, action)=>{
                    switch (action.type) {
                        case checkingQuery:
                            if (logic){
                                return logic(state, action.data);
                            }
                            return action.data;
                        default:
                            return state;
                    }
                }
            }

            let allReports = higherOrderReducer({}, 'ADD_ALL_REPORTS');
            let comparedReports = higherOrderReducer({}, 'ADD_COMPARED_REPORTS');
            let branch1 = higherOrderReducer('', 'CHANGE_BRANCH1');
            let branch2 = higherOrderReducer('', 'CHANGE_BRANCH2');
            let testCase = higherOrderReducer('', 'CHANGE_TEST_CASE');
            let selectedMetric = higherOrderReducer('', 'CHANGE_SELECTED_METRIC');
            let sideHeadings = higherOrderReducer([], 'UPDATE_SIDE_HEADINGS');
            let branches = higherOrderReducer([], 'ADD_BRANCHES', (state, data)=>[...state, ...data]);

            let metrics = (state=[], action)=>{
                return state;
            }

            let initState = {
                allReports: {},
                comparedReports: {},
                branch1: '',
                branch2: '',
                testCase: '',
                sideHeadings: [],
                branches: [],
                selectedMetric: 'All',
                metrics: ['All', 'Page Load', 'API', 'Marks', 'Long Tasks', 'Paints']
            }

            let reducers = Redux.combineReducers({allReports, comparedReports, branch1, branch2, branches, testCase, metrics, selectedMetric, sideHeadings});

            let logMiddleware = (store)=>{
                return (next)=>{
                    return (action)=>{
                        let a = next(action);
                        // console.log(store.getState());
                        return a;
                    }
                }
            }
            var store = Redux.createStore(reducers, initState, Redux.applyMiddleware(logMiddleware));

            let higherOrderActionCreater = (actionType)=>{
                return (data)=>{
                    return {
                        type: actionType,
                        data: data
                    }
                }
            }

            var addAllReports = higherOrderActionCreater('ADD_ALL_REPORTS');
            var addComparedReports = higherOrderActionCreater('ADD_COMPARED_REPORTS');
            var updateBranch1 = higherOrderActionCreater('CHANGE_BRANCH1');
            var updateBranch2 = higherOrderActionCreater('CHANGE_BRANCH2');
            var updateBranches = higherOrderActionCreater('ADD_BRANCHES');
            var updateTestCase = higherOrderActionCreater('CHANGE_TEST_CASE');
            var updateSideHeadings = higherOrderActionCreater('UPDATE_SIDE_HEADINGS');
            var changeSelectedMetric = higherOrderActionCreater('CHANGE_SELECTED_METRIC');

            class App extends React.Component{
                constructor(props){
                    super(props);
                }

                render(){
                    return <HOCReport/>
                }
            }

            class Report extends React.Component{
                constructor(props){
                    super(props);
                    this.state = {
                        selectedBranch1: '',
                        selectedBranch2: '',
                        wantAllMetrics: false
                    }
                    this.handleTestCase = this.handleTestCase.bind(this);
                    this.handleSelectedMetric = this.handleSelectedMetric.bind(this);
                    this.handleBranches = this.handleBranches.bind(this);
                    this.compareSelectedBranches = this.compareSelectedBranches.bind(this);
                    this.handleWantMetrics = this.handleWantMetrics.bind(this);
                }

                handleWantMetrics(){
                    let { wantMetric } = this.refs;
                    let isWant = false;
                    if (wantMetric.value === 'All'){
                        isWant = true;
                    }
                    this.setState({
                        wantAllMetrics: isWant
                    })
                }

                handleBranches(ref){
                    let value = this.refs[ref].value;
                    if (ref === 'branch1'){
                        this.setState({
                            selectedBranch1: value
                        })
                    }else{
                        this.setState({
                            selectedBranch2: value
                        })
                    }
                }

                compareSelectedBranches(){
                    let { branch1, branch2, allReports, addComparedReports, updateSideHeadings } = this.props;
                    let { selectedBranch1, selectedBranch2 } = this.state;
                    let { report, sideHeadings } = compareObjects(allReports, selectedBranch1, selectedBranch2);
                    addComparedReports(report);
                    updateSideHeadings(sideHeadings);
                    this.props.updateBranch2(selectedBranch2);
                    this.props.updateBranch1(selectedBranch1);
                }

                handleSelectedMetric(){
                    let { selectMetric } = this.refs;
                    this.props.changeSelectedMetric(selectMetric.value);
                }

                handleTestCase(heading){
                    this.props.updateTestCase(heading);
                }

                render(){
                    console.log('render');
                    let { reportValues, sideHeadings, selectedMetric, metrics, comparedReports, testCase, previousDate, currentDate, branch1, branch2, branches } = this.props;
                    let { selectedBranch1, selectedBranch2, wantAllMetrics } = this.state;
                    currentDate = getDateFormat(currentDate);
                    previousDate = getDateFormat(previousDate);
                    return <div className={'whole'}>
                        <div className={'title'}>{'Performance Report'}</div>
                        <div className={'content'}>
                            <div className={'leftpanel'}>
                                {
                                    sideHeadings.map((heading, key)=>{
                                        let color = {
                                            color: 'black',
                                            backgroundColor: 'white',
                                            border: '1px solid black'
                                        }
                                        color = heading === testCase ? color : null;
                                        return <div style={color} className={'sideHeading'} key={heading} onClick = {this.handleTestCase.bind(undefined, heading)}>{heading}</div>
                                    })
                                }
                            </div>
                            <div className={'selectParent'}>
                                {
                                    <div className={'wholeBranch'}>
                                        {
                                            branches.length !==0 && [1,2].map(index=>{
                                                let branchValue = index === 1 ? selectedBranch1 : index === 2 ? selectedBranch2 : null;
                                                return <div className={'branchCompare'}>
                                                    <span>{'Branch ' + index + ' : '}</span>
                                                    <select onChange={this.handleBranches.bind(undefined, 'branch'+index)} ref={'branch' + index} value = {branchValue} key={index * Math.floor(Math.random() * 100)}>
                                                        {
                                                            branches.map((branch, id)=>{
                                                                return <option value={branch} key={id}>{branch}</option>
                                                            })
                                                        }
                                                    </select>
                                                </div>
                                            })
                                        }
                                        {
                                            branches.length !==0 && <button onClick={this.compareSelectedBranches} className={'reportSubmit'}>Compare Reports</button>
                                        }
                                    </div>
                                }
                                <div className={'rightSideWhole'}>
                                    {
                                        branches.length !==0 && <div>
                                            <span>{'Filter by : '}</span>
                                            <select ref={'selectMetric'} onChange={this.handleSelectedMetric} value = {selectedMetric}>
                                                {
                                                    metrics && metrics.map((metric, id)=>{
                                                        return <option key={id}>{metric}</option>
                                                    })
                                                }
                                            </select>
                                        </div>
                                    }
                                    {
                                        branches.length !==0 && <div>
                                            <span>{'Hide/Show All details : '}</span>
                                            <select ref={'wantMetric'} onChange={this.handleWantMetrics} value = {wantAllMetrics ? 'All' : 'Filtered'}>
                                                <option>{'All'}</option>
                                                <option>{'Filtered'}</option>
                                            </select>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div className={'rightpanel'}>
                                <div className={'reportName'}>
                                    {
                                        currentDate && <div className={'dateBox'}>
                                            <div className={'dateInfo'} style={{color:'red'}}>{'Current Report Info'}</div>
                                            <div className={'dateInfo'}>{'Date : ' + currentDate.date}</div>
                                            <div className={'dateInfo'}>{'Time : ' + currentDate.time}</div>
                                        </div>
                                    }
                                    {
                                        previousDate && <div className={'dateBox'}>
                                            <div className={'dateInfo'} style={{color:'red'}}>{'Previous Report Info'}</div>
                                            <div className={'dateInfo'}>{'Date : ' + previousDate.date}</div>
                                            <div className={'dateInfo'}>{'Time : ' + previousDate.time}</div>
                                        </div>
                                    }
                                </div>
                                    {
                                        comparedReports && Object.keys(comparedReports).map((testCaseName, index)=>{
                                            if (testCaseName !== testCase){
                                                return null;
                                            }
                                            let allReports = getValueFromObject(selectedMetric, comparedReports[testCase])
                                            let data = Object.keys(allReports).map((key, index)=>{
                                                let metric = allReports[key];
                                                return metric.map(report=>{
                                                    return <div data-table className={'table'} key={index}>
                                                            <h2>{report.entryType ? metricsToStandard[report.entryType.current] : metricsToStandard[Object.keys(report)[0]]}</h2>
                                                            <h3>{report.name ? report.name.current : metricsToStandard[Object.keys(report)[0]]}</h3>
                                                            <div className={'row'}>
                                                                <div className={'columnHeading'}>{'Metric Names'}</div>
                                                                <div className={'columnHeading'}>{branch1 + ' branch value'}</div>
                                                                <div className={'columnHeading'}>{branch2 + ' branch value'}</div>
                                                                <div className={'columnHeading'}>{'Difference'}</div>
                                                            </div>
                                                            <div className={'tableWhole'}>
                                                                {
                                                                    Object.keys(report).map(key=>{
                                                                        let metric = report[key];
                                                                        if (!wantAllMetrics){
                                                                            if (filterArray.indexOf(key) !== -1){
                                                                                 return null;
                                                                             }
                                                                        }
                                                                        let { current, previous, difference, color } = metric;
                                                                        current = isValue(current);
                                                                        previous = isValue(previous);
                                                                        difference = isValue(difference);
                                                                        current = metricsToStandard[current] ? metricsToStandard[current] : current;
                                                                        previous = metricsToStandard[previous] ? metricsToStandard[previous] : previous;
                                                                        let colorObj = {
                                                                            color: color
                                                                        }
                                                                        let differenceColor = {
                                                                            color: difference === '-None-' ? 'black' : color
                                                                        }
                                                                        return <div className={'row'} key={key}>
                                                                            <div data-tableHeading className={'rowHeading'}>{metricsToStandard[key]}</div>
                                                                            <div className={'value'} title={addMetricToNumber(current)} style={colorObj}>{addMetricToNumber(current)}</div>
                                                                            <div className={'value'} title={addMetricToNumber(previous)} style={colorObj}>{addMetricToNumber(previous)}</div>
                                                                            <div className={'value'} title={addMetricToNumber(difference)} style={differenceColor}>{addMetricToNumber(difference)}</div>
                                                                        </div>
                                                                    })
                                                                }
                                                            </div>
                                                        </div>
                                                    })
                                                })
                                                return data.length !== 1 ? data : data[0].length !== 0 ? data : <center><h1>{'There is No Reports!'}</h1></center>;
                                            })
                                    }
                            </div>
                        </div>
                    </div>
                }

                componentDidMount(){
                    let { addAllReports, addComparedReports, changeSelectedMetric, updateBranch1, updateBranch2, updateSideHeadings, updateTestCase, updateBranches } = this.props;
                    let concatReports = Object.assign(reports, master);
                    let { report, sideHeadings, branch1, branch2, branches } = compareObjects(concatReports);
                    addAllReports(concatReports);
                    addComparedReports(report);
                    updateBranch1(branch1);
                    updateBranch2(branch2);
                    updateSideHeadings(sideHeadings);
                    updateTestCase(sideHeadings[0]);
                    updateBranches(branches);
                    this.setState({
                        selectedBranch1: branch1,
                        selectedBranch2: branch2,
                        branches
                    })
                }

                componentDidUpdate(){
                    let tables = document.querySelectorAll('[data-table]');
                    tables.forEach(table=>{
                        if (table.offsetHeight < 350){
                            table.children[3].style.overflowY = 'hidden';
                            table.querySelectorAll('[data-tableHeading]').forEach(heading=>{
                                heading.style.width = '25%';
                            })
                        }
                    })
                }
            }

            let HOCReport = ReactRedux.connect(state=>{
                return {
                    allReports: state.allReports,
                    comparedReports: state.comparedReports,
                    branch1: state.branch1,
                    branch2: state.branch2,
                    sideHeadings: state.sideHeadings,
                    branches: state.branches,
                    testCase: state.testCase,
                    selectedMetric: state.selectedMetric,
                    metrics: state.metrics
                }
            }, { addAllReports, changeSelectedMetric, addComparedReports, updateBranch1, updateTestCase, updateBranch2, updateBranches, updateSideHeadings})(Report)

            let Provider = ReactRedux.Provider;

            ReactDOM.render(
                <Provider store={store}>
                    <App/>
                </Provider>, output
            )

        </script>

        <script>
            let index = -1;
            let getDefaultKey = (object)=>{
                index++;
                if(Object.keys(object)[index]){
                    return Object.keys(object)[index];
                }
            }

            let commonCompareObject = (object1, object2)=>{
                var comparedObj = {};
                var testCases = [];
                let obj2Keys = Object.keys(object2);
                var others = 'black';
                if (object1 && !isEmptyObject(object1)){
                    Object.keys(object1).forEach(function(branch1Key){
                        testCases.push(branch1Key);
                        if (obj2Keys.indexOf(branch1Key) !== -1){
                            obj2Keys.splice(obj2Keys.indexOf(branch1Key), 1);
                        }
                        comparedObj[branch1Key] = [];
                        let branch1Obj = object1[branch1Key];
                        let branch2Obj = object2[branch1Key];
                        if (isObject(branch1Obj)){
                            Object.keys(branch1Obj).forEach(metric=>{
                                comparedObj[branch1Key][metric] = [];
                                let branch1Value = branch1Obj[metric];
                                var branch2Value = branch2Obj ? branch2Obj[metric] : null;
                                branch1Value.forEach(function(branch1Data, index){
                                    var branch2Data = branch2Value ? branch2Value[index] : null;
                                    var commonObj = {};
                                    if(isObject(branch1Data)){
                                        Object.keys(branch1Data).forEach(function(objKey){
                                            let value1 = branch1Data[objKey];
                                            let value2 = branch2Data ? branch2Data[objKey] : null;
                                            var obj = {};
                                            if (isNumber(value1)){
                                                value1 = parseInt(value1);
                                                value2 = parseInt(value2);
                                                var colorObj = selectColor(value1, value2);
                                                obj.color = colorObj.color;
                                                obj.difference = colorObj.value;
                                                obj.current = value1;
                                                obj.previous = value2;
                                            }else if (isString(value1)){
                                                obj.current = value1;
                                                obj.previous = value2;
                                                obj.color = others;
                                            }
                                            commonObj[objKey] = obj;
                                        })
                                    }else{
                                        var obj = {};
                                        obj.previous = branch2Data ? branch2Data : null;
                                        obj.current = branch1Data;
                                        if (isNumber(branch1Data)){
                                            var colorObj = selectColor(branch1Data, branch2Data);
                                            obj.color = colorObj.color;
                                            obj.difference = colorObj.value;
                                        }else{
                                            obj.color = others;
                                        }
                                        commonObj[metric] = obj;
                                    }
                                    comparedObj[branch1Key][metric].push(commonObj);
                                })
                            })
                        }
                    })
                }
                if (obj2Keys.length !== 0){
                    let newObj = {};
                    obj2Keys.forEach(key=>{
                        newObj[key] = object2[key];
                    })
                    newObj = commonCompareObject(newObj, {});
                    comparedObj = Object.assign(comparedObj, newObj.comparedObj);
                    testCases = testCases.concat(newObj.testCases);
                }
                return {
                    comparedObj: comparedObj,
                    testCases: testCases
                }
            }

            let compareObjects = (object, key1=getDefaultKey(object), key2=getDefaultKey(object))=>{
                let branch1 = object[key1];
                let branch2 = object[key2];
                let branches = Object.keys(object);
                let {comparedObj, testCases} = commonCompareObject(branch1, branch2);
                return {
                    report: comparedObj,
                    sideHeadings: testCases,
                    branch1: key1,
                    branch2: key2,
                    branches: branches
                }
            }

            function selectColor(currentValue, previousValue = currentValue){
                var danger = 'red';
                var good = 'blue';
                var improve = 'green';
                var others = 'black';
                var color, value;
                if (currentValue > previousValue){
                    color = danger;
                    value = currentValue - previousValue;
                }else if (currentValue === previousValue){
                    color = good;
                    value = currentValue;
                }else{
                    color = improve;
                    value = currentValue - previousValue;
                }
                return {
                    value: value,
                    color: color
                }
            }

            var combineKeys = {
                'Page Load': ['tti', 'navigation','resource'],
                'API': ['resource'],
                'All': ['tti', 'navigation','resource', 'paint', 'mark', 'longtask', 'measure'],
                'Long Tasks': ['longtask']
            }

            function getValueFromObject(key, object){
                if (combineKeys[key]){
                    var copyObj = {};
                    return combineKeys[key].reduce((obj, id, index)=>{
                        if (index === 0){
                            copyObj = obj;
                        }
                        if (index === combineKeys[key].length - 1){
                            obj = Object.assign(obj, getValueFromObject(id, object))
                            return copyObj;
                        }
                        return Object.assign(obj, getValueFromObject(id, object));
                    },{})
                }
                return object ? {[key]: object[key] ? object[key] : []} : null;
            }

            function isEmptyObject(obj){
                return JSON.stringify(obj) === '{}' ? true : false;
            }

            function isObject(object){
                if (object){
                    return object.toString() === '[object Object]' ? true : false;
                }
                return false;
            }

            function addMetricToNumber(value){
                return parseInt(value) ? value + ' ms' : value;
            }

            function isValue(value){
                return value ? value : '-None-'
            }

            function isString(str){
                return typeof str === 'string' ? true : false;
            }

            function isNumber(number){
                return Number(number) ? true : false;
            }

            function getDateFormat(data){
                if (!data) return null;
                let dateObj = new Date(parseInt(data));
                let date = dateObj.getDate();
                let month = dateObj.getMonth();
                let year = dateObj.getFullYear();
                let time = dateObj.getHours();
                let minutes = dateObj.getMinutes();
                let seconds = dateObj.getSeconds();
                if (time > 12){
                    time = time - 12;
                    time = time + ':' + minutes + ':' + seconds + ' PM';
                }else{
                    time = time + ':' + minutes + ':' + seconds + ' AM';
                }
                date = date + ' - ' + month + ' - ' + year;
                return {
                    date: date,
                    time: time
                }
            }
        </script>

        <script>
            let filterArray = ['entryType', 'initiatorType', 'workerStart', 'redirectEnd', 'redirectStart', 'secureConnectionStart',
                'requestStart', 'responseStart', 'unloadEventEnd', 'unloadEventStart', 'domContentLoadedEventStart', 'domContentLoadedEventEnd',
                'loadEventStart', 'loadEventEnd', 'type', 'redirectCount', 'name'
            ];

            let metricsToStandard = {
                paint: 'Paint',
                longtask: 'Long Task',
                mark: 'Marks',
                measure: 'Measure',
                resource: 'Resource',
                navigation: 'Navigation',
                tti: 'Time to Intractive',
                name: 'Name',
                entryType: 'Entry Type',
                startTime: 'Start Time',
                duration: 'Duration',
                initiatorType: 'Initiator Type',
                nextHopProtocol: 'Next Hop Protocol',
                workerStart: 'Worker Start',
                redirectStart: 'Redirect Start',
                redirectEnd: 'Redirect End',
                fetchStart: 'Fetch Start',
                domainLookupStart: 'Domain Lookup Start',
                domainLookupEnd: 'Domain Lookup End',
                connectStart: 'Connect Start',
                connectEnd: 'Connect End',
                secureConnectionStart: 'Secure Connection Start',
                requestStart: 'Request Start',
                responseStart: 'Response Start',
                responseEnd: 'Response End',
                transferSize: 'Transfer Size',
                encodedBodySize: 'Encoded Body Size',
                decodedBodySize: 'Decoded Body Size',
                unloadEventStart: 'Unload Event Start',
                unloadEventEnd: 'Unload Event End',
                domInteractive: 'DOM Interactive',
                domContentLoadedEventStart: 'DOM ContentLoaded Event Start',
                domContentLoadedEventEnd: 'DOM Content Loaded Event End',
                domComplete: 'DOM Complete',
                loadEventStart: 'Load Event Start',
                loadEventEnd: 'Load Event End',
                type: 'Type',
                redirectCount: 'Redirect Count',
                self: 'Self',
                reload: 'Reload',
                'http/1.1': 'http - 1.1'
            }


        </script>
    </body>
</html>
